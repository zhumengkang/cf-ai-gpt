<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF AI Chat - å¤šæ¨¡å‹èŠå¤©åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .config-notice {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 10px;
            padding: 15px;
            margin: 20px;
            text-align: center;
        }
        
        .config-notice h3 {
            color: #92400e;
            margin-bottom: 10px;
        }
        
        .config-input {
            margin: 10px 0;
        }
        
        .config-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .config-input input {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .auth-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .auth-section.authenticated {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        
        .model-section {
            margin-bottom: 20px;
        }
        
        .model-section h3 {
            margin-bottom: 10px;
            color: #374151;
        }
        
        .model-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .model-info {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .model-info strong {
            color: #1e40af;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #4338ca;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #374151;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }
        
        .message {
            margin-bottom: 20px;
            max-width: 80%;
        }
        
        .message.user {
            margin-left: auto;
        }
        
        .message-content {
            padding: 15px;
            border-radius: 15px;
            line-height: 1.6;
        }
        
        .message.user .message-content {
            background: #4f46e5;
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.assistant .message-content {
            background: white;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 5px;
        }
        
        .message-meta {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
            text-align: right;
        }
        
        .message.assistant .message-meta {
            text-align: left;
        }
        
        .input-area {
            background: white;
            border-top: 1px solid #e2e8f0;
            padding: 20px;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .message-input {
            flex: 1;
            min-height: 50px;
            max-height: 120px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            resize: none;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .send-btn {
            height: 50px;
            padding: 0 20px;
            background: #10b981;
            border-radius: 12px;
        }
        
        .send-btn:hover {
            background: #059669;
        }
        
        .history-section {
            margin-top: 20px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #fecaca;
        }
        
        .success {
            background: #f0f9ff;
            color: #0369a1;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #bae6fd;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .container {
                height: 100vh;
                border-radius: 0;
            }
            
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– CF AI Chat</h1>
            <p>æ”¯æŒå¤šæ¨¡å‹åˆ‡æ¢çš„æ™ºèƒ½èŠå¤©åŠ©æ‰‹</p>
        </div>
        
        <!-- APIé…ç½®åŒºåŸŸ -->
        <div class="config-notice" id="configSection">
            <h3>âš™ï¸ è¯·å…ˆé…ç½®APIç«¯ç‚¹</h3>
            <p>è¯·è¾“å…¥æ‚¨çš„Cloudflare Workers APIåœ°å€ï¼š</p>
            <div class="config-input">
                <label for="apiUrlInput">Worker API URL:</label>
                <input type="url" id="apiUrlInput" placeholder="https://your-worker.your-subdomain.workers.dev" />
            </div>
            <button class="btn" onclick="setApiUrl()">ç¡®è®¤è®¾ç½®</button>
        </div>
        
        <div class="main-content" id="mainContent" style="display: none;">
            <div class="sidebar">
                <!-- å¯†ç éªŒè¯åŒºåŸŸ -->
                <div class="auth-section" id="authSection">
                    <div class="input-group">
                        <label for="passwordInput">è®¿é—®å¯†ç </label>
                        <input type="password" id="passwordInput" placeholder="è¯·è¾“å…¥è®¿é—®å¯†ç ">
                    </div>
                    <button class="btn" onclick="authenticate()">éªŒè¯</button>
                </div>
                
                <!-- æ¨¡å‹é€‰æ‹©åŒºåŸŸ -->
                <div class="model-section" id="modelSection" style="display: none;">
                    <h3>ğŸ¯ é€‰æ‹©AIæ¨¡å‹</h3>
                    <select class="model-select" id="modelSelect" onchange="updateModelInfo()">
                        <option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>
                    </select>
                    <div class="model-info" id="modelInfo">
                        è¯·å…ˆé€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹
                    </div>
                </div>
                
                <!-- å†å²è®°å½•åŒºåŸŸ -->
                <div class="history-section" id="historySection" style="display: none;">
                    <h3>ğŸ“š èŠå¤©å†å²</h3>
                    <button class="btn btn-secondary" onclick="loadHistory()">åŠ è½½å†å²è®°å½•</button>
                    <button class="btn btn-secondary" onclick="clearHistory()" style="margin-left: 5px;">æ¸…ç©ºå†å²</button>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="messages" id="messages">
                    <div class="message assistant">
                        <div class="message-content">
                            ğŸ‘‹ æ¬¢è¿ä½¿ç”¨CF AI Chatï¼è¯·å…ˆè¾“å…¥å¯†ç éªŒè¯èº«ä»½ï¼Œç„¶åé€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹å¼€å§‹èŠå¤©ã€‚
                        </div>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    ğŸ¤” AIæ­£åœ¨æ€è€ƒä¸­...
                </div>
                
                <div class="input-area">
                    <div class="input-container">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..." 
                            disabled
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button class="btn send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                            å‘é€
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isAuthenticated = false;
        let currentPassword = '';
        let models = {};
        let chatHistory = [];
        let currentModel = '';
        let apiUrl = '';

        // è®¾ç½®API URL
        function setApiUrl() {
            const input = document.getElementById('apiUrlInput');
            const url = input.value.trim();
            
            if (!url) {
                showError('è¯·è¾“å…¥APIåœ°å€');
                return;
            }
            
            // éªŒè¯URLæ ¼å¼
            try {
                new URL(url);
                apiUrl = url.endsWith('/') ? url.slice(0, -1) : url;
                localStorage.setItem('cfAiChatApiUrl', apiUrl);
                
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'flex';
                
                // åŠ è½½æ¨¡å‹åˆ—è¡¨
                loadModels();
            } catch (error) {
                showError('è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€');
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®API URL
        window.onload = function() {
            const savedApiUrl = localStorage.getItem('cfAiChatApiUrl');
            if (savedApiUrl) {
                apiUrl = savedApiUrl;
                document.getElementById('apiUrlInput').value = apiUrl;
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'flex';
                loadModels();
            }
        };

        async function loadModels() {
            try {
                const response = await fetch(`${apiUrl}/api/models`);
                if (response.ok) {
                    models = await response.json();
                    populateModelSelect();
                } else {
                    showError('æ— æ³•è¿æ¥åˆ°APIæœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®');
                }
            } catch (error) {
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            }
        }

        function populateModelSelect() {
            const select = document.getElementById('modelSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¨¡å‹...</option>';
            
            for (const [key, model] of Object.entries(models)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = model.name;
                select.appendChild(option);
            }
        }

        function updateModelInfo() {
            const select = document.getElementById('modelSelect');
            const infoDiv = document.getElementById('modelInfo');
            const selectedModel = select.value;
            
            if (!selectedModel) {
                infoDiv.innerHTML = 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªAIæ¨¡å‹';
                return;
            }
            
            currentModel = selectedModel;
            const model = models[selectedModel];
            
            infoDiv.innerHTML = `
                <strong>${model.name}</strong><br>
                ğŸ“ ${model.description}<br><br>
                ğŸ’° <strong>æ”¶è´¹æ ‡å‡†:</strong><br>
                â€¢ è¾“å…¥: $${model.input_price}/ç™¾ä¸‡tokens<br>
                â€¢ è¾“å‡º: $${model.output_price}/ç™¾ä¸‡tokens<br><br>
                ğŸ“ <strong>ä¸Šä¸‹æ–‡çª—å£:</strong> ${model.context.toLocaleString()} tokens
            `;
            
            // å¯ç”¨è¾“å…¥æ¡†
            if (isAuthenticated) {
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }

        async function authenticate() {
            const password = document.getElementById('passwordInput').value;
            if (!password) {
                showError('è¯·è¾“å…¥å¯†ç ');
                return;
            }

            try {
                // æµ‹è¯•å¯†ç æ˜¯å¦æ­£ç¡®
                const response = await fetch(`${apiUrl}/api/models`, {
                    headers: {
                        'Authorization': `Bearer ${password}`
                    }
                });

                if (response.ok) {
                    isAuthenticated = true;
                    currentPassword = password;
                    
                    const authSection = document.getElementById('authSection');
                    authSection.className = 'auth-section authenticated';
                    authSection.innerHTML = '<p>âœ… èº«ä»½éªŒè¯æˆåŠŸï¼</p>';
                    
                    document.getElementById('modelSection').style.display = 'block';
                    document.getElementById('historySection').style.display = 'block';
                    
                    showSuccess('éªŒè¯æˆåŠŸï¼è¯·é€‰æ‹©AIæ¨¡å‹å¼€å§‹èŠå¤©ã€‚');
                    
                    // åŠ è½½å†å²è®°å½•
                    await loadHistory();
                } else {
                    showError('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                showError('éªŒè¯å¤±è´¥: ' + error.message);
            }
        }

        async function sendMessage() {
            if (!isAuthenticated || !currentModel) {
                showError('è¯·å…ˆéªŒè¯èº«ä»½å¹¶é€‰æ‹©æ¨¡å‹');
                return;
            }

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                return;
            }

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°ç•Œé¢
            addMessage('user', message);
            input.value = '';
            
            // æ·»åŠ åˆ°å†å²è®°å½•
            chatHistory.push({ role: 'user', content: message, timestamp: new Date() });

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('loading').style.display = 'block';
            document.getElementById('sendBtn').disabled = true;

            try {
                const response = await fetch(`${apiUrl}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        model: currentModel,
                        password: currentPassword,
                        history: chatHistory.slice(-10) // åªå‘é€æœ€è¿‘10æ¡å†å²è®°å½•
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessage('assistant', data.reply, data.model, data.usage);
                    chatHistory.push({ 
                        role: 'assistant', 
                        content: data.reply, 
                        timestamp: new Date(),
                        model: data.model 
                    });
                    
                    // è‡ªåŠ¨ä¿å­˜å†å²è®°å½•
                    await saveHistory();
                } else {
                    showError(data.error || 'å‘é€æ¶ˆæ¯å¤±è´¥');
                }
            } catch (error) {
                showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('sendBtn').disabled = false;
            }
        }

        function addMessage(role, content, modelName = '', usage = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            let metaInfo = new Date().toLocaleTimeString();
            if (modelName) {
                metaInfo = `${modelName} â€¢ ${metaInfo}`;
            }
            if (usage && usage.total_tokens) {
                metaInfo += ` â€¢ ${usage.total_tokens} tokens`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
                <div class="message-meta">${metaInfo}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function loadHistory() {
            if (!isAuthenticated) return;

            try {
                const response = await fetch(`${apiUrl}/api/history?password=${encodeURIComponent(currentPassword)}&sessionId=default`);
                const data = await response.json();
                
                if (response.ok) {
                    chatHistory = data.history || [];
                    
                    // æ¸…ç©ºç°æœ‰æ¶ˆæ¯å¹¶é‡æ–°åŠ è½½
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '<div class="message assistant"><div class="message-content">ğŸ“š å†å²è®°å½•å·²åŠ è½½</div></div>';
                    
                    chatHistory.forEach(msg => {
                        addMessage(msg.role, msg.content, msg.model || '');
                    });
                    
                    if (chatHistory.length === 0) {
                        showSuccess('æš‚æ— å†å²è®°å½•');
                    } else {
                        showSuccess(`å·²åŠ è½½ ${chatHistory.length} æ¡å†å²è®°å½•`);
                    }
                } else {
                    showError(data.error || 'åŠ è½½å†å²è®°å½•å¤±è´¥');
                }
            } catch (error) {
                showError('åŠ è½½å†å²è®°å½•å¤±è´¥: ' + error.message);
            }
        }

        async function saveHistory() {
            if (!isAuthenticated) return;

            try {
                await fetch(`${apiUrl}/api/history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: currentPassword,
                        sessionId: 'default',
                        history: chatHistory
                    })
                });
            } catch (error) {
                console.error('Save history failed:', error);
            }
        }

        async function clearHistory() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ')) {
                return;
            }

            chatHistory = [];
            await saveHistory();
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '<div class="message assistant"><div class="message-content">âœ¨ èŠå¤©è®°å½•å·²æ¸…ç©º</div></div>';
            
            showSuccess('èŠå¤©è®°å½•å·²æ¸…ç©º');
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = message;
            
            // æ ¹æ®å½“å‰æ˜¾ç¤ºçš„å†…å®¹å†³å®šæ·»åŠ åˆ°å“ªé‡Œ
            const target = document.getElementById('configSection').style.display === 'none' ? 
                          document.querySelector('.sidebar') : 
                          document.getElementById('configSection');
            target.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;
            
            const target = document.getElementById('configSection').style.display === 'none' ? 
                          document.querySelector('.sidebar') : 
                          document.getElementById('configSection');
            target.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 3000);
        }
    </script>
</body>
</html>
