<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CF AI Chat - 多模型聊天助手</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        
        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .config-notice {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 10px;
            padding: 15px;
            margin: 20px;
            text-align: center;
        }
        
        .config-notice h3 {
            color: #92400e;
            margin-bottom: 10px;
        }
        
        .config-input {
            margin: 10px 0;
        }
        
        .config-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .config-input input {
            width: 100%;
            max-width: 400px;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
        }
        
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .auth-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .auth-section.authenticated {
            background: #d1ecf1;
            border-color: #bee5eb;
        }
        
        .model-section {
            margin-bottom: 20px;
        }
        
        .model-section h3 {
            margin-bottom: 10px;
            color: #374151;
        }
        
        .model-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .model-info {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.4;
        }
        
        .model-info strong {
            color: #1e40af;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #4338ca;
        }
        
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #6b7280;
        }
        
        .btn-secondary:hover {
            background: #374151;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }
        
        .message {
            margin-bottom: 20px;
            max-width: 80%;
        }
        
        .message.user {
            margin-left: auto;
        }
        
        .message-content {
            padding: 15px;
            border-radius: 15px;
            line-height: 1.6;
        }
        
        .message.user .message-content {
            background: #4f46e5;
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message.assistant .message-content {
            background: white;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 5px;
        }
        
        .message-meta {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
            text-align: right;
        }
        
        .message.assistant .message-meta {
            text-align: left;
        }
        
        .input-area {
            background: white;
            border-top: 1px solid #e2e8f0;
            padding: 20px;
        }
        
        .input-container {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .message-input {
            flex: 1;
            min-height: 50px;
            max-height: 120px;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            resize: none;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .send-btn {
            height: 50px;
            padding: 0 20px;
            background: #10b981;
            border-radius: 12px;
        }
        
        .send-btn:hover {
            background: #059669;
        }
        
        .history-section {
            margin-top: 20px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #fecaca;
        }
        
        .success {
            background: #f0f9ff;
            color: #0369a1;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #bae6fd;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
            
            .container {
                height: 100vh;
                border-radius: 0;
            }
            
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 CF AI Chat</h1>
            <p>支持多模型切换的智能聊天助手</p>
        </div>
        
        <!-- API配置区域 -->
        <div class="config-notice" id="configSection">
            <h3>⚙️ 请先配置API端点</h3>
            <p>请输入您的Cloudflare Workers API地址：</p>
            <div class="config-input">
                <label for="apiUrlInput">Worker API URL:</label>
                <input type="url" id="apiUrlInput" placeholder="https://your-worker.your-subdomain.workers.dev" />
            </div>
            <button class="btn" onclick="setApiUrl()">确认设置</button>
        </div>
        
        <div class="main-content" id="mainContent" style="display: none;">
            <div class="sidebar">
                <!-- 密码验证区域 -->
                <div class="auth-section" id="authSection">
                    <div class="input-group">
                        <label for="passwordInput">访问密码</label>
                        <input type="password" id="passwordInput" placeholder="请输入访问密码">
                    </div>
                    <button class="btn" onclick="authenticate()">验证</button>
                </div>
                
                <!-- 模型选择区域 -->
                <div class="model-section" id="modelSection" style="display: none;">
                    <h3>🎯 选择AI模型</h3>
                    <select class="model-select" id="modelSelect" onchange="updateModelInfo()">
                        <option value="">请选择模型...</option>
                    </select>
                    <div class="model-info" id="modelInfo">
                        请先选择一个AI模型
                    </div>
                </div>
                
                <!-- 历史记录区域 -->
                <div class="history-section" id="historySection" style="display: none;">
                    <h3>📚 聊天历史</h3>
                    <button class="btn btn-secondary" onclick="loadHistory()">加载历史记录</button>
                    <button class="btn btn-secondary" onclick="clearHistory()" style="margin-left: 5px;">清空历史</button>
                </div>
            </div>
            
            <div class="chat-area">
                <div class="messages" id="messages">
                    <div class="message assistant">
                        <div class="message-content">
                            👋 欢迎使用CF AI Chat！请先输入密码验证身份，然后选择一个AI模型开始聊天。
                        </div>
                    </div>
                </div>
                
                <div class="loading" id="loading">
                    🤔 AI正在思考中...
                </div>
                
                <div class="input-area">
                    <div class="input-container">
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="输入您的问题..." 
                            disabled
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button class="btn send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                            发送
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isAuthenticated = false;
        let currentPassword = '';
        let models = {};
        let chatHistory = [];
        let currentModel = '';
        let apiUrl = '';

        // 设置API URL
        function setApiUrl() {
            const input = document.getElementById('apiUrlInput');
            const url = input.value.trim();
            
            if (!url) {
                showError('请输入API地址');
                return;
            }
            
            // 验证URL格式
            try {
                new URL(url);
                apiUrl = url.endsWith('/') ? url.slice(0, -1) : url;
                localStorage.setItem('cfAiChatApiUrl', apiUrl);
                
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'flex';
                
                // 加载模型列表
                loadModels();
            } catch (error) {
                showError('请输入有效的URL地址');
            }
        }

        // 页面加载时检查是否已设置API URL
        window.onload = function() {
            const savedApiUrl = localStorage.getItem('cfAiChatApiUrl');
            if (savedApiUrl) {
                apiUrl = savedApiUrl;
                document.getElementById('apiUrlInput').value = apiUrl;
                document.getElementById('configSection').style.display = 'none';
                document.getElementById('mainContent').style.display = 'flex';
                loadModels();
            }
        };

        async function loadModels() {
            try {
                const response = await fetch(`${apiUrl}/api/models`);
                if (response.ok) {
                    models = await response.json();
                    populateModelSelect();
                } else {
                    showError('无法连接到API服务器，请检查URL是否正确');
                }
            } catch (error) {
                showError('网络错误: ' + error.message);
            }
        }

        function populateModelSelect() {
            const select = document.getElementById('modelSelect');
            select.innerHTML = '<option value="">请选择模型...</option>';
            
            for (const [key, model] of Object.entries(models)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = model.name;
                select.appendChild(option);
            }
        }

        function updateModelInfo() {
            const select = document.getElementById('modelSelect');
            const infoDiv = document.getElementById('modelInfo');
            const selectedModel = select.value;
            
            if (!selectedModel) {
                infoDiv.innerHTML = '请先选择一个AI模型';
                return;
            }
            
            currentModel = selectedModel;
            const model = models[selectedModel];
            
            infoDiv.innerHTML = `
                <strong>${model.name}</strong><br>
                📝 ${model.description}<br><br>
                💰 <strong>收费标准:</strong><br>
                • 输入: $${model.input_price}/百万tokens<br>
                • 输出: $${model.output_price}/百万tokens<br><br>
                📏 <strong>上下文窗口:</strong> ${model.context.toLocaleString()} tokens
            `;
            
            // 启用输入框
            if (isAuthenticated) {
                document.getElementById('messageInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }

        async function authenticate() {
            const password = document.getElementById('passwordInput').value;
            if (!password) {
                showError('请输入密码');
                return;
            }

            try {
                // 测试密码是否正确
                const response = await fetch(`${apiUrl}/api/models`, {
                    headers: {
                        'Authorization': `Bearer ${password}`
                    }
                });

                if (response.ok) {
                    isAuthenticated = true;
                    currentPassword = password;
                    
                    const authSection = document.getElementById('authSection');
                    authSection.className = 'auth-section authenticated';
                    authSection.innerHTML = '<p>✅ 身份验证成功！</p>';
                    
                    document.getElementById('modelSection').style.display = 'block';
                    document.getElementById('historySection').style.display = 'block';
                    
                    showSuccess('验证成功！请选择AI模型开始聊天。');
                    
                    // 加载历史记录
                    await loadHistory();
                } else {
                    showError('密码错误，请重试');
                }
            } catch (error) {
                showError('验证失败: ' + error.message);
            }
        }

        async function sendMessage() {
            if (!isAuthenticated || !currentModel) {
                showError('请先验证身份并选择模型');
                return;
            }

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) {
                return;
            }

            // 添加用户消息到界面
            addMessage('user', message);
            input.value = '';
            
            // 添加到历史记录
            chatHistory.push({ role: 'user', content: message, timestamp: new Date() });

            // 显示加载状态
            document.getElementById('loading').style.display = 'block';
            document.getElementById('sendBtn').disabled = true;

            try {
                const response = await fetch(`${apiUrl}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        model: currentModel,
                        password: currentPassword,
                        history: chatHistory.slice(-10) // 只发送最近10条历史记录
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    addMessage('assistant', data.reply, data.model, data.usage);
                    chatHistory.push({ 
                        role: 'assistant', 
                        content: data.reply, 
                        timestamp: new Date(),
                        model: data.model 
                    });
                    
                    // 自动保存历史记录
                    await saveHistory();
                } else {
                    showError(data.error || '发送消息失败');
                }
            } catch (error) {
                showError('网络错误: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('sendBtn').disabled = false;
            }
        }

        function addMessage(role, content, modelName = '', usage = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            let metaInfo = new Date().toLocaleTimeString();
            if (modelName) {
                metaInfo = `${modelName} • ${metaInfo}`;
            }
            if (usage && usage.total_tokens) {
                metaInfo += ` • ${usage.total_tokens} tokens`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
                <div class="message-meta">${metaInfo}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function loadHistory() {
            if (!isAuthenticated) return;

            try {
                const response = await fetch(`${apiUrl}/api/history?password=${encodeURIComponent(currentPassword)}&sessionId=default`);
                const data = await response.json();
                
                if (response.ok) {
                    chatHistory = data.history || [];
                    
                    // 清空现有消息并重新加载
                    const messagesDiv = document.getElementById('messages');
                    messagesDiv.innerHTML = '<div class="message assistant"><div class="message-content">📚 历史记录已加载</div></div>';
                    
                    chatHistory.forEach(msg => {
                        addMessage(msg.role, msg.content, msg.model || '');
                    });
                    
                    if (chatHistory.length === 0) {
                        showSuccess('暂无历史记录');
                    } else {
                        showSuccess(`已加载 ${chatHistory.length} 条历史记录`);
                    }
                } else {
                    showError(data.error || '加载历史记录失败');
                }
            } catch (error) {
                showError('加载历史记录失败: ' + error.message);
            }
        }

        async function saveHistory() {
            if (!isAuthenticated) return;

            try {
                await fetch(`${apiUrl}/api/history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: currentPassword,
                        sessionId: 'default',
                        history: chatHistory
                    })
                });
            } catch (error) {
                console.error('Save history failed:', error);
            }
        }

        async function clearHistory() {
            if (!confirm('确定要清空所有聊天记录吗？')) {
                return;
            }

            chatHistory = [];
            await saveHistory();
            
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '<div class="message assistant"><div class="message-content">✨ 聊天记录已清空</div></div>';
            
            showSuccess('聊天记录已清空');
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = message;
            
            // 根据当前显示的内容决定添加到哪里
            const target = document.getElementById('configSection').style.display === 'none' ? 
                          document.querySelector('.sidebar') : 
                          document.getElementById('configSection');
            target.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;
            
            const target = document.getElementById('configSection').style.display === 'none' ? 
                          document.querySelector('.sidebar') : 
                          document.getElementById('configSection');
            target.appendChild(div);
            
            setTimeout(() => {
                div.remove();
            }, 3000);
        }
    </script>
</body>
</html>
