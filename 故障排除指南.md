# 🔧 CF AI Chat 故障排除指南

## 📋 目录
- [部署阶段问题](#部署阶段问题)
- [运行时问题](#运行时问题)
- [功能问题](#功能问题)
- [性能问题](#性能问题)
- [安全问题](#安全问题)
- [调试方法](#调试方法)

## 🚀 部署阶段问题

### 问题1：GitHub Actions部署失败

#### 错误信息：`Error: Authentication failed`
**可能原因：**
- CLOUDFLARE_API_TOKEN错误或过期
- API Token权限不足
- CLOUDFLARE_ACCOUNT_ID错误

**解决步骤：**
1. 检查GitHub Secrets中的API Token是否正确
2. 重新生成Cloudflare API Token：
   - 访问 [API Tokens页面](https://dash.cloudflare.com/profile/api-tokens)
   - 创建新Token，确保权限包含：
     ```
     Account: Cloudflare Workers:Edit
     Zone: Zone Settings:Read
     Zone: Zone:Read
     ```
3. 更新GitHub Secrets中的 `CLOUDFLARE_API_TOKEN`
4. 重新运行Actions

#### 错误信息：`Error: A request to the Cloudflare API failed`
**可能原因：**
- 网络连接问题
- Cloudflare服务暂时不可用
- 配置文件格式错误

**解决步骤：**
1. 检查wrangler.toml文件格式是否正确
2. 验证KV命名空间ID是否存在
3. 等待几分钟后重试
4. 查看Cloudflare状态页面确认服务状态

#### 错误信息：`Error: KV namespace with id "xxx" not found`
**可能原因：**
- KV命名空间ID错误
- KV命名空间被删除
- Account ID不匹配

**解决步骤：**
1. 登录Cloudflare Dashboard检查KV命名空间
2. 复制正确的命名空间ID
3. 更新wrangler.toml文件
4. 重新提交代码

### 问题2：GitHub Pages部署失败

#### 错误信息：`Failed to deploy pages`
**可能原因：**
- GitHub Pages未启用
- 分支设置错误
- 文件权限问题

**解决步骤：**
1. 进入仓库Settings > Pages
2. 确认Source设置为"GitHub Actions"
3. 检查工作流权限：
   - Settings > Actions > General
   - 确保"Read and write permissions"已启用

## 🏃 运行时问题

### 问题3：Worker部署成功但无法访问

#### 症状：访问Worker URL返回错误
**可能原因：**
- Worker代码有语法错误
- 环境变量配置错误
- AI绑定未配置

**诊断方法：**
1. 在Cloudflare Dashboard查看Worker日志
2. 使用浏览器开发者工具查看网络请求
3. 直接访问Worker URL根路径，应返回API状态信息

**解决步骤：**
1. 检查Worker代码是否完整
2. 验证环境变量配置：
   - CHAT_PASSWORD
   - MODEL_CONFIG
3. 确认绑定配置：
   - AI绑定：变量名 "AI"
   - KV绑定：变量名 "CHAT_HISTORY"

### 问题4：API调用返回500错误

#### 错误信息：`Internal Server Error`
**可能原因：**
- MODEL_CONFIG格式错误
- 模型ID不存在
- AI服务未启用

**解决步骤：**
1. 验证MODEL_CONFIG JSON格式：
   ```bash
   # 使用在线JSON验证器检查格式
   ```
2. 确认模型ID正确性：
   - 检查是否有拼写错误
   - 验证模型是否在CF AI目录中
3. 检查Cloudflare账户AI服务状态

### 问题5：CORS错误

#### 错误信息：`Access to fetch at 'xxx' from origin 'xxx' has been blocked by CORS policy`
**可能原因：**
- Worker CORS配置问题
- 请求头设置错误

**解决步骤：**
1. 检查Worker代码中的CORS设置：
   ```javascript
   const corsHeaders = {
     'Access-Control-Allow-Origin': '*',
     'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
     'Access-Control-Allow-Headers': 'Content-Type, Authorization',
   };
   ```
2. 确认所有响应都包含CORS头
3. 验证前端请求格式正确

## 🛠️ 功能问题

### 问题6：密码验证失败

#### 症状：输入正确密码仍提示错误
**可能原因：**
- 密码配置不一致
- 特殊字符编码问题
- 大小写问题

**解决步骤：**
1. 检查Worker环境变量中的CHAT_PASSWORD
2. 与wrangler.toml中的密码对比
3. 确认密码没有前后空格
4. 避免使用特殊字符，或使用URL编码

**测试方法：**
```javascript
// 在浏览器控制台测试
fetch('/api/models', {
  headers: { 'Authorization': 'Bearer your-password' }
}).then(r => r.json()).then(console.log);
```

### 问题7：模型列表加载失败

#### 症状：前端显示"无法连接到API服务器"
**可能原因：**
- Worker URL错误
- 网络连接问题
- API路由配置错误

**解决步骤：**
1. 验证Worker URL格式：
   - 正确：`https://worker-name.account.workers.dev`
   - 错误：缺少https://或格式不对
2. 直接访问 `/api/models` 端点测试
3. 检查网络连接和防火墙设置

### 问题8：聊天消息发送失败

#### 错误信息：`调用AI模型时发生错误`
**可能原因：**
- 模型配置错误
- Cloudflare AI配额超限
- 模型暂时不可用

**诊断步骤：**
1. 检查Cloudflare Dashboard中的AI使用统计
2. 验证账户余额
3. 尝试不同的模型
4. 查看Worker运行日志

**解决方法：**
1. 检查模型配置中的 `use_messages` 参数
2. 验证模型ID正确性
3. 确认账户有足够余额
4. 减少请求频率

### 问题9：历史记录无法保存

#### 症状：刷新页面后聊天记录丢失
**可能原因：**
- KV绑定配置错误
- KV命名空间权限问题
- 存储配额超限

**解决步骤：**
1. 验证KV绑定配置：
   ```
   Variable name: CHAT_HISTORY
   KV namespace: 选择正确的命名空间
   ```
2. 检查KV存储使用量：
   - 免费账户：1GB存储，100,000次读取/天
3. 测试KV读写功能：
   ```javascript
   // 在Worker中测试
   await env.CHAT_HISTORY.put('test', 'value');
   const value = await env.CHAT_HISTORY.get('test');
   ```

### 问题10：模型切换无效

#### 症状：切换模型后仍使用旧模型
**可能原因：**
- 前端状态管理问题
- 缓存问题
- 请求参数错误

**解决步骤：**
1. 清空浏览器缓存
2. 重新加载页面
3. 检查浏览器开发者工具中的网络请求
4. 验证请求体中的model参数

## ⚡ 性能问题

### 问题11：响应速度慢

#### 症状：AI回复需要很长时间
**可能原因：**
- 模型负载高
- 网络延迟
- 请求上下文过长

**优化方法：**
1. 选择性能更好的模型（如gpt-oss-20b）
2. 减少历史上下文长度
3. 使用CDN加速前端资源
4. 选择地理位置更近的CF数据中心

### 问题12：并发请求限制

#### 症状：多用户同时使用时出现错误
**可能原因：**
- Worker并发限制
- AI服务配额限制
- KV存储频率限制

**解决方案：**
1. 升级Cloudflare账户套餐
2. 实现请求队列机制
3. 添加请求频率限制
4. 使用Durable Objects处理状态

## 🔒 安全问题

### 问题13：密码被猜测

#### 症状：发现未授权访问
**解决方案：**
1. 立即更改密码
2. 使用更复杂的密码
3. 考虑添加IP白名单
4. 监控访问日志

### 问题14：API密钥泄露

#### 症状：GitHub Secrets可能泄露
**应急处理：**
1. 立即在Cloudflare删除API Token
2. 创建新的API Token
3. 更新GitHub Secrets
4. 检查账户异常活动
5. 重新部署Worker

## 🔍 调试方法

### 启用Worker日志
1. 在Cloudflare Dashboard中查看Real-time Logs
2. 在Worker代码中添加console.log：
   ```javascript
   console.log('Debug info:', variable);
   ```

### 浏览器调试
1. 打开开发者工具（F12）
2. 查看Console标签页的错误信息
3. 检查Network标签页的请求响应
4. 使用Application标签页查看LocalStorage

### API测试
使用curl或Postman测试API端点：
```bash
# 测试模型列表
curl https://your-worker.workers.dev/api/models

# 测试聊天接口
curl -X POST https://your-worker.workers.dev/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "message": "Hello",
    "model": "gpt-oss-20b",
    "password": "your-password"
  }'
```

### 配置验证
1. 检查wrangler.toml语法：
   ```bash
   wrangler validate
   ```
2. 验证JSON格式：
   - 使用在线JSON验证器
   - 检查括号、引号、逗号

### 错误日志分析
常见错误模式：
- `TypeError: Cannot read property 'xxx' of undefined`：变量未定义
- `SyntaxError: Unexpected token`：语法错误
- `ReferenceError: xxx is not defined`：引用错误
- `Network Error`：网络连接问题

## 📞 获取帮助

### 官方文档
- [Cloudflare Workers文档](https://developers.cloudflare.com/workers/)
- [Workers AI文档](https://developers.cloudflare.com/workers-ai/)
- [KV存储文档](https://developers.cloudflare.com/workers/learning/how-kv-works/)

### 社区支持
- [Cloudflare Discord](https://discord.cloudflare.com/)
- [GitHub Issues](https://github.com/cloudflare/workers-sdk/issues)
- [Stack Overflow](https://stackoverflow.com/questions/tagged/cloudflare-workers)

### 诊断清单
在寻求帮助前，请准备以下信息：
- [ ] 错误的具体信息和截图
- [ ] 出现问题的确切步骤
- [ ] 配置文件内容（隐去敏感信息）
- [ ] 浏览器开发者工具的错误日志
- [ ] Worker的实时日志
- [ ] 使用的模型和配置
- [ ] 网络环境信息

记住：大多数问题都是配置错误导致的，仔细检查每个配置项通常能解决90%的问题！
